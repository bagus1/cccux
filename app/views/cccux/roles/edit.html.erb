<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>Edit Role: <%= @role.name %></h1>
  <div>
    <%= link_to "View Role", cccux.role_path(@role), 
        style: "background-color: #17a2b8; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px; margin-right: 0.5rem;" %>
    <%= link_to "Back to Roles", cccux.roles_path, 
        style: "background-color: #6c757d; color: white; padding: 0.5rem 1rem; text-decoration: none; border-radius: 4px;" %>
  </div>
</div>

<%= form_with model: [@role], url: cccux.role_path(@role), local: true, method: :patch do |form| %>
  <% if @role.errors.any? %>
    <div style="background-color: #f8d7da; border: 1px solid #721c24; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
      <h4><%= pluralize(@role.errors.count, "error") %> prohibited this role from being saved:</h4>
      <ul>
        <% @role.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- Basic Role Information -->
    <div style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem;">
      <h3 style="margin-top: 0; color: #495057;">Basic Information</h3>
      
      <div style="margin-bottom: 1.5rem;">
        <%= form.label :name, style: "display: block; margin-bottom: 0.5rem; font-weight: bold; color: #495057;" %>
        <%= form.text_field :name, 
            style: "width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem;" %>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <%= form.label :description, style: "display: block; margin-bottom: 0.5rem; font-weight: bold; color: #495057;" %>
        <%= form.text_area :description, rows: 4,
            style: "width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; resize: vertical;" %>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <%= form.check_box :active, { checked: @role.active.nil? ? true : @role.active }, 
              style: "margin-right: 0.5rem; transform: scale(1.2);" %>
          <span style="font-weight: bold; color: #495057;">Active Role</span>
        </label>
        <small style="color: #6c757d; font-size: 0.9rem; margin-top: 0.25rem; display: block; margin-left: 1.5rem;">
          Only active roles can be assigned to users. Inactive roles are hidden from user assignment forms.
        </small>
      </div>
      
      <div style="background-color: #f8f9fa; padding: 1rem; border-radius: 4px;">
        <strong style="color: #495057;">Current Users:</strong>
        <div style="margin-top: 0.5rem;">
          <%= pluralize(@role.users.count, 'user') %> assigned to this role
        </div>
      </div>
    </div>
    
    <!-- Permission Management -->
    <div style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem;">
      <h3 style="margin-top: 0; color: #495057;">Permissions</h3>
      
      <!-- Permission Legend -->
      <div style="background-color: #e7f3ff; border: 1px solid #b8daff; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
        <h6 style="margin: 0 0 0.5rem 0; color: #004085; font-weight: bold;">Access Types:</h6>
        <div style="font-size: 0.85rem; color: #004085; line-height: 1.4;">
          <div style="margin-bottom: 0.25rem;"><strong>Global:</strong> Access all records everywhere</div>
          <div style="margin-bottom: 0.25rem;"><strong>Contextual:</strong> Access records within current route context (e.g., store-scoped resources)</div>
          <div style="margin-bottom: 0.25rem;"><strong>Owned:</strong> Access only to records owned by the current user</div>
        </div>
      </div>
      
      <% if @available_permissions.any? %>
        <% @available_permissions.each do |subject, permissions| %>
          <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e9ecef; border-radius: 4px;">
            <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-weight: bold;"><%= subject %></h5>
            
            <!-- Action Permissions with Access Type Controls -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 0.5rem;">
              <% permissions.each do |permission| %>
                <% 
                  # Check if this permission is currently assigned to the role
                  is_assigned = @role.ability_permissions.include?(permission)
                  
                  # Get the current access type for this specific permission
                  role_ability = @role.role_abilities.find_by(ability_permission: permission)
                  current_access_type = role_ability&.access_type || 'global'
                %>
                
                <div style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid #e9ecef; border-radius: 4px; background-color: #f8f9fa;"
                     data-permission-id="<%= permission.id %>">
                  <!-- Permission Checkbox -->
                  <div style="margin-right: 1rem; min-width: 100px;">
                    <%= check_box_tag "role[ability_permission_ids][]", 
                        permission.id, 
                        is_assigned,
                        style: "margin-right: 0.5rem;",
                        class: "permission-checkbox",
                        data: { permission_id: permission.id } %>
                    <span style="font-size: 0.9rem; color: #495057; font-weight: bold;">
                      <%= permission.action.capitalize %>
                    </span>
                  </div>
                  
                  <!-- Access Type Controls -->
                  <div style="margin-left: auto; display: flex; align-items: center; gap: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;" class="access-controls">
                      <span style="font-size: 0.8rem; color: #6c757d; font-weight: bold;">Access:</span>
                      
                      <%= radio_button_tag "role[permission_access_type][#{permission.id}]", "global", 
                          current_access_type == 'global', 
                          id: "access_global_#{permission.id}",
                          style: "margin-right: 0.25rem;",
                          class: "access-radio",
                          disabled: !is_assigned %>
                      <%= label_tag "access_global_#{permission.id}", "Global", 
                          style: "font-size: 0.8rem; cursor: pointer; margin-right: 0.75rem;",
                          class: "access-label #{is_assigned ? '' : 'text-muted'}" %>
                      
                      <%= radio_button_tag "role[permission_access_type][#{permission.id}]", "contextual", 
                          current_access_type == 'contextual', 
                          id: "access_contextual_#{permission.id}",
                          style: "margin-right: 0.25rem;",
                          class: "access-radio",
                          disabled: !is_assigned %>
                      <%= label_tag "access_contextual_#{permission.id}", "Contextual", 
                          style: "font-size: 0.8rem; cursor: pointer; margin-right: 0.75rem;",
                          class: "access-label #{is_assigned ? '' : 'text-muted'}" %>
                      
                      <%= radio_button_tag "role[permission_access_type][#{permission.id}]", "owned", 
                          current_access_type == 'owned', 
                          id: "access_owned_#{permission.id}",
                          style: "margin-right: 0.25rem;",
                          class: "access-radio",
                          disabled: !is_assigned %>
                      <%= label_tag "access_owned_#{permission.id}", "Owned", 
                          style: "font-size: 0.8rem; cursor: pointer;",
                          class: "access-label #{is_assigned ? '' : 'text-muted'}" %>
                    </div>
                  </div>
                </div>
                
                <!-- Ownership Configuration (shown when "Owned" is selected) -->
                <div class="ownership-config" 
                     style="display: none; margin-top: 0.5rem; padding: 0.75rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;"
                     data-permission-id="<%= permission.id %>">
                  <div style="font-size: 0.8rem; color: #856404; font-weight: bold; margin-bottom: 0.5rem;">
                    Ownership Configuration:
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                      <label style="font-size: 0.75rem; color: #856404; display: block; margin-bottom: 0.25rem;">
                        Ownership Model:
                      </label>
                      <%= select_tag "role[ownership_source][#{permission.id}]", 
                          options_for_select([['Select model...', '']] + (@available_ownership_models || []).map { |m| [m, m] }, role_ability&.ownership_source),
                          class: "ownership-source-field",
                          data: { permission_id: permission.id },
                          style: "width: 100%; padding: 0.25rem; font-size: 0.75rem; border: 1px solid #ffeaa7; border-radius: 2px;" %>
                      <small style="font-size: 0.7rem; color: #856404;">
                        Model that defines ownership (optional)
                      </small>
                    </div>
                    
                    <div>
                      <label style="font-size: 0.75rem; color: #856404; display: block; margin-bottom: 0.25rem;">
                        Foreign Key:
                      </label>
                      <%= text_field_tag "role[ownership_foreign_key][#{permission.id}]", 
                          (role_ability&.ownership_conditions.present? ? JSON.parse(role_ability.ownership_conditions)["foreign_key"] : nil),
                          placeholder: "e.g., store_id",
                          style: "width: 100%; padding: 0.25rem; font-size: 0.75rem; border: 1px solid #ffeaa7; border-radius: 2px;",
                          class: "ownership-foreign-key-field" %>
                      <small style="font-size: 0.7rem; color: #856404;">
                        Links to main model (auto-detected if blank)
                      </small>
                    </div>
                  </div>
                  
                  <div>
                    <label style="font-size: 0.75rem; color: #856404; display: block; margin-bottom: 0.25rem;">
                      User Key:
                    </label>
                    <%= text_field_tag "role[ownership_user_key][#{permission.id}]", 
                        (role_ability&.ownership_conditions.present? ? JSON.parse(role_ability.ownership_conditions)["user_key"] : nil),
                        placeholder: "e.g., user_id",
                        style: "width: 100%; padding: 0.25rem; font-size: 0.75rem; border: 1px solid #ffeaa7; border-radius: 2px;",
                        class: "ownership-user-key-field" %>
                    <small style="font-size: 0.7rem; color: #856404;">
                      Identifies the user (defaults to user_id)
                    </small>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        
        <!-- Hidden field to ensure empty array is sent when no permissions are selected -->
        <%= hidden_field_tag "role[ability_permission_ids][]", "", id: nil %>
      <% else %>
        <p style="color: #6c757d; font-style: italic;">No permissions available to assign.</p>
      <% end %>
    </div>
  </div>

  <!-- Enhanced JavaScript for permission interactions -->
  <script>
    document.addEventListener('DOMContentLoaded', initializeRoleForm);
    document.addEventListener('turbo:load', initializeRoleForm);
    
    function initializeRoleForm() {
      // Handle permission checkboxes and access type radios
      const permissionCheckboxes = document.querySelectorAll('.permission-checkbox');
      
      permissionCheckboxes.forEach(checkbox => {
        const permissionId = checkbox.value;
        const accessTypeRadios = document.querySelectorAll(`input[name="role[permission_access_type][${permissionId}]"]`);
        const accessLabels = document.querySelectorAll(`label[for^="access_"][for$="_${permissionId}"]`);
        const ownershipConfig = document.querySelector(`.ownership-config[data-permission-id="${permissionId}"]`);
        
        function updateAccessTypeVisibility() {
          const isChecked = checkbox.checked;
          
          // Enable/disable access type radios
          accessTypeRadios.forEach(radio => {
            radio.disabled = !isChecked;
          });
          
          // Update label opacity
          accessLabels.forEach(label => {
            label.style.opacity = isChecked ? '1' : '0.5';
            if (isChecked) {
              label.classList.remove('text-muted');
            } else {
              label.classList.add('text-muted');
            }
          });
          
          // Hide ownership config when permission is unchecked
          if (ownershipConfig) {
            if (!isChecked) {
              ownershipConfig.style.display = 'none';
            } else {
              // Check if "Owned" is selected
              const ownedRadio = document.querySelector(`#access_owned_${permissionId}`);
              if (ownedRadio && ownedRadio.checked) {
                ownershipConfig.style.display = 'block';
              }
            }
          }
        }
        
        checkbox.addEventListener('change', updateAccessTypeVisibility);
        updateAccessTypeVisibility();
      });
      
      // Handle access type radio changes to show/hide ownership config
      const accessRadios = document.querySelectorAll('.access-radio');
      
      accessRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          // Extract permission ID from the radio button name or ID
          const permissionId = this.name.match(/\[(\d+)\]$/)?.[1] || this.id.match(/_(\d+)$/)?.[1];
          const ownershipConfig = document.querySelector(`.ownership-config[data-permission-id="${permissionId}"]`);
          const checkbox = document.querySelector(`input[value="${permissionId}"].permission-checkbox`);
          
          if (ownershipConfig && checkbox && checkbox.checked) {
            if (this.value === 'owned') {
              ownershipConfig.style.display = 'block';
            } else {
              ownershipConfig.style.display = 'none';
            }
          }
        });
      });
      
      // Handle ownership source model dropdown
      const ownershipSourceSelects = document.querySelectorAll('.ownership-source-field');
      
      ownershipSourceSelects.forEach(select => {
        select.addEventListener('change', function() {
          const permissionId = this.dataset.permissionId;
          const selectedModel = this.value;
          
          if (selectedModel) {
            console.log(`Model selected for permission ${permissionId}: ${selectedModel}`);
          }
        });
      });
      
      // Add CSS for muted text
      if (!document.getElementById('cccux-muted-style')) {
        const style = document.createElement('style');
        style.id = 'cccux-muted-style';
        style.textContent = `
          .text-muted {
            color: #6c757d !important;
          }
        `;
        document.head.appendChild(style);
      }
    }
  </script>

  <!-- Form Actions -->
  <div style="background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <%= form.submit "Update Role", 
            style: "background-color: #28a745; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; margin-right: 1rem;" %>
        <%= link_to "Cancel", cccux.role_path(@role), 
            style: "color: #6c757d; text-decoration: none; padding: 0.75rem 1rem; font-size: 1rem;" %>
      </div>
      
      <% unless @role.users.any? %>
        <div>
          <%= link_to "Delete Role", cccux.role_path(@role), 
              data: { "turbo-method": :delete, "turbo-confirm": "Are you sure? This action cannot be undone." },
              style: "background-color: #dc3545; color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 4px; font-size: 1rem;" %>
        </div>
      <% else %>
        <div style="color: #6c757d; font-size: 0.9rem; font-style: italic;">
          Cannot delete role with assigned users
        </div>
      <% end %>
    </div>
  </div>
<% end %>